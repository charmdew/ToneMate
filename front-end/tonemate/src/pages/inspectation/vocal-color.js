import Head from "next/head";
import Layout from "@/components/layout";
import TitleContainer from "@/components/content/title-container";
import MainContainer from "@/components/content/main-container";

import { useRef, useState } from "react";

export default function VocalColor() {
  // 상태 관리
  const [isRecording, setIsRecording] = useState(false);
  const [isFinish, setIsFinish] = useState(false);
  const [isDrawing, setIsDrawing] = useState(true);
  const [drawID, setdrawID] = useState(null);
  const [stream, setStream] = useState(null);
  const [audioCtx, setAudioCtx] = useState(null);
  const [analyser, setAnalyser] = useState(null);
  const [recordedBlob, setRecordedBlob] = useState(null);
  const mediaRecorderRef = useRef(null);
  const mediaStreamRef = useRef(null);
  const canvasRef = useRef(null);

  // 함수 : 녹음 시작
  const startRecording = async () => {
    const mediaStream = navigator.mediaDevices
      .getUserMedia({ audio: true })
      .then((stream) => {
        const audioCtx = new AudioContext();
        const source = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);
        setStream(stream);
        setAudioCtx(audioCtx);
        setAnalyser(analyser);

        function draw() {
          if (isDrawing) {
            const ID = requestAnimationFrame(draw);
            setdrawID(ID);
            analyser.getByteFrequencyData(dataArray);
            const canvasCtx = canvasRef.current.getContext("2d");
            const WIDTH = canvasRef.current.width;
            const HEIGHT = canvasRef.current.height;
            canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
            const barWidth = (WIDTH / bufferLength) * 2.5;
            let x = 0;
            for (let i = 0; i < bufferLength; i++) {
              const barHeight = dataArray[i];
              canvasCtx.fillStyle = "white";
              canvasCtx.fillRect(
                x,
                HEIGHT - barHeight / 2,
                barWidth,
                barHeight
              );
              x += barWidth + 1;
            }
          }
        }

        mediaStreamRef.current = stream;

        const mediaRecorder = new MediaRecorder(stream);
        mediaRecorderRef.current = mediaRecorder;

        const chunks = [];

        mediaRecorder.addEventListener("dataavailable", (event) => {
          chunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", () => {
          const blob = new Blob(chunks, { type: "audio/wav" });
          setRecordedBlob(blob);
          const audioURL = window.URL.createObjectURL(blob);
          const audio = new Audio(audioURL);
          audio.play();
        });

        mediaRecorder.start();
        setIsRecording(true);
        draw();
      })
      .catch((error) => {
        console.error("Error accessing microphone:", error);
      });
  };

  // 함수 : 녹음 완료
  const stopRecording = () => {
    mediaRecorderRef.current.stop();
    mediaStreamRef.current.getTracks().forEach((track) => track.stop());
    cancelAnimationFrame(drawID);
    setIsFinish(true);
    setIsDrawing(false);
  };

  // 함수 : 검사 하기
  const finishTest = () => {
    console.log(recordedBlob);
    const audioURL = window.URL.createObjectURL(recordedBlob);
    const audio = new Audio(audioURL);
    audio.play();

    const formData = new FormData();
    formData.append("audio", recordedBlob);
  };

  return (
    <>
      <Head>
        <title>음색검사</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>
        <Layout>
          <TitleContainer>
            <p className="text-xl lg:text-4xl text-white">음색검사</p>
          </TitleContainer>
          <MainContainer>
            {/* 음색 검사 주의사항 및 방법 */}
            <div className="flex flex-col w-full  h-40 lg:h-48 fade-in-custom-10s">
              <p className="flex font-nanum text-white text-xl lg:text-3xl my-2">
                음색 검사 절차 및 유의사항
              </p>
              <p className="flex font-nanum text-white text-sm lg:text-lg my-1 ml-2">
                1. 조용한 환경에서 녹음을 실시합니다.
              </p>
              <p className="flex font-nanum text-white text-sm lg:text-lg my-1 ml-2">
                2. 녹음 시작을 클릭하고 아래 제시된 문장을 읽습니다.
              </p>
              <p className="flex font-nanum text-white text-sm lg:text-lg my-1 ml-2">
                3. 녹음이 완료된 후 녹음 완료 버튼을 클릭합니다.
              </p>
              <p className="flex font-nanum text-white text-sm lg:text-lg my-1 ml-2">
                4. 검사 제출 버튼을 클릭합니다.
              </p>
            </div>
            {/* 읽어야할 문구 */}
            <div className="flex flex-col w-full h-44 lg:h-60 justify-start items-center lg:items-start bg-transparent fade-in-custom-15s">
              <div className="flex flex-row justify-start items-start mb-2">
                <p className="flex font-nanum text-white text-lg lg:text-3xl">
                  제시된 문장
                </p>
              </div>
              <div className="flex flex-col grow w-full justify-center items-center bg-slate-500 rounded-xl">
                <p className="flex font-nanum text-white text-center text-sm lg:text-xl my-1">
                  본 강의는 삼성청년 SW아카데미의 컨텐츠로 보안서약
                </p>
                <p className="flex font-nanum text-white text-center text-sm lg:text-xl my-1">
                  의거하여 강의 내용을 어떠한 사유로도 임의로 복사,
                </p>
                <p className="flex font-nanum text-white text-center text-sm lg:text-xl my-1">
                  복제, 보관, 전송하거나 허가 받지 않은 저장매체를 이용
                </p>
                <p className="flex font-nanum text-white text-center text-sm lg:text-xl my-1">
                  제 3자에게 누설, 공개 또는 사용하는 등의 행위를 금
                </p>
              </div>
            </div>
            {/* 녹음 버튼 및 오디오 비주얼라이제이션 */}
            <div className="flex flex-row w-full h-44 lg:h-60 fade-in-custom-20s">
              <div className="flex w-1/2 h-full p-1 rounded-xl bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500 ">
                <div className="flex w-full h-full bg-black justify-center items-center rounded-xl">
                  <canvas
                    ref={canvasRef}
                    className="flex w-5/6 h-5/6 "
                  ></canvas>
                </div>
              </div>
              <div className="flex flex-col w-1/2 h-full justify-around items-center bg-transparent">
                <button
                  onClick={startRecording}
                  disabled={isRecording}
                  className="flex flex-row w-5/6 h-1/4 border-2 rounded-lg justify-center items-center"
                >
                  <p className="text-white text-lg">녹음 시작</p>
                </button>
                <button
                  onClick={stopRecording}
                  disabled={isFinish}
                  className="flex flex-row w-5/6 h-1/4 border-2 rounded-lg justify-center items-center"
                >
                  <p className="text-white text-lg">녹음 완료</p>
                </button>
                <button
                  onClick={finishTest}
                  className="flex flex-row w-5/6 h-1/4 border-2 rounded-lg justify-center items-center"
                >
                  <p className="text-white text-lg">검사 제출</p>
                </button>
                {/* <button onClick={handleStopRecording} disabled={!isRecording}>
                  Stop
                </button> */}
              </div>
            </div>
          </MainContainer>
        </Layout>
      </main>
    </>
  );
}
